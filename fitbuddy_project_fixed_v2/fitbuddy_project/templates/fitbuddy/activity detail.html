<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Activity Details</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center p-4">

    <!-- Message Modal -->
    <div id="message-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-sm w-full shadow-lg">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="text-gray-700 mb-4"></p>
            <button id="modal-close-btn" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition">Close</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="w-full max-w-4xl bg-white rounded-2xl shadow-xl overflow-hidden p-8">

        <!-- Activity Header -->
        <header class="flex flex-col items-center text-center pb-6 border-b-2 border-gray-200 mb-6">
            <img src="https://placehold.co/400x200/4c51bf/ffffff?text=Activity+Image" alt="Activity Visual" class="w-full rounded-xl mb-4 shadow-md">
            <h1 id="activity-title" class="text-4xl font-extrabold text-gray-900 mb-2"></h1>
            <p id="activity-description" class="text-gray-600 text-lg max-w-2xl"></p>
        </header>

        <!-- Sessions Section -->
        <section class="mt-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Upcoming Sessions</h2>
            <div id="sessions-container" class="grid grid-cols-1 gap-6">
                <!-- This is where the sessions will be dynamically loaded -->
                <p class="text-gray-500 text-center py-8">No upcoming sessions found.</p>
            </div>
        </section>

    </div>

    <!-- JavaScript for Interactivity -->
    <script>
        // The __app_id is provided by the canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Placeholder data to simulate Django context
        // In your Django template, you would populate these variables
        const activity = {
            title: 'Group Yoga',
            description: 'A relaxing and mindful session focused on flexibility, balance, and inner peace. Suitable for all skill levels.',
            pk: 1
        };

        const sessions = [
            { id: 101, startTime: '2025-10-25T10:00:00Z', duration: 60, confirmedCount: 5, effectiveCapacity: 12, isBooked: false, isWaiting: false },
            { id: 102, startTime: '2025-10-26T18:00:00Z', duration: 60, confirmedCount: 12, effectiveCapacity: 12, isBooked: false, isWaiting: false },
            { id: 103, startTime: '2025-10-27T08:00:00Z', duration: 60, confirmedCount: 10, effectiveCapacity: 12, isBooked: true, isWaiting: false }
        ];

        document.getElementById('activity-title').textContent = activity.title;
        document.getElementById('activity-description').textContent = activity.description;

        const sessionsContainer = document.getElementById('sessions-container');
        sessionsContainer.innerHTML = ''; // Clear placeholder

        sessions.forEach(session => {
            const sessionDiv = document.createElement('div');
            sessionDiv.className = 'bg-gray-100 p-6 rounded-lg shadow flex flex-col md:flex-row items-center justify-between';
            
            const sessionTime = new Date(session.startTime).toLocaleString('en-US', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            sessionDiv.innerHTML = `
                <div class="mb-4 md:mb-0">
                    <h3 class="text-lg font-semibold text-gray-900">${sessionTime}</h3>
                    <p class="text-sm text-gray-500">${session.duration} minutes</p>
                    <p class="text-sm text-gray-500">
                        ${session.confirmedCount}/${session.effectiveCapacity} Confirmed
                    </p>
                </div>
                <div>
                    ${renderBookingButton(session)}
                </div>
            `;
            sessionsContainer.appendChild(sessionDiv);
        });

        function renderBookingButton(session) {
            if (session.isBooked) {
                return `<span class="bg-green-500 text-white text-sm font-semibold py-2 px-4 rounded-full">Booked</span>`;
            } else if (session.confirmedCount >= session.effectiveCapacity) {
                return `<button data-session-id="${session.id}" class="book-btn bg-yellow-500 text-gray-800 font-bold py-2 px-4 rounded-full shadow-md hover:bg-yellow-600 transition">
                            Join Waitlist
                        </button>`;
            } else {
                return `<button data-session-id="${session.id}" class="book-btn bg-indigo-600 text-white font-bold py-2 px-4 rounded-full shadow-md hover:bg-indigo-700 transition">
                            Book Now
                        </button>`;
            }
        }

        sessionsContainer.addEventListener('click', async (e) => {
            if (e.target.classList.contains('book-btn')) {
                const sessionId = e.target.dataset.sessionId;
                try {
                    const response = await fetch(`/book/${sessionId}/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': getCookie('csrftoken'),
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    });

                    const result = await response.json();
                    if (result.status === 'ok') {
                        // Here you would re-render the sessions list with updated data
                        // For this example, we'll just show a success message
                        showMessageModal('Success!', 'Your session has been booked successfully.');
                    } else {
                        showMessageModal('Error', result.message || 'An unknown error occurred.');
                    }
                } catch (error) {
                    console.error('Error booking session:', error);
                    showMessageModal('Error', 'An error occurred while trying to book your session.');
                }
            }
        });

        // Helper function to get CSRF token from cookies
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Show a custom modal instead of alert()
        function showMessageModal(title, message) {
            const modal = document.getElementById('message-modal');
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modal.classList.remove('hidden');
        }

        document.getElementById('modal-close-btn').addEventListener('click', () => {
            document.getElementById('message-modal').classList.add('hidden');
        });
    </script>
</body>
</html>
